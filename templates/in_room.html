<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
          crossorigin="anonymous">
    <!-- <link rel="stylesheet"
          href="../static/css/in_room.css"> -->
    <title> {{ title }} </title>
    <style>
        .main, body, html {
            height: 100%;
            width: 100%;
            padding: 0;
            margin: 0;
            background-color: #525252;
        }


        #price {
            width: 40%;
            height: 80%;
            float: right;
            padding-top: 1%;
            background-color: #3c3f41;

        }

        #me {
            width: 100%;
            height: 10%;
            float: left;
        }

        #menu {
            width: 40%;
            height: 20%;
            float: left;

        }

        td {
            width: 10%;
            height: 17.5%;
            padding: 5px;
            margin: 20px;
            background-color: #c6c6c6;

        }

        tr {
            padding: 5px;
            margin: 20px;

        }

        table {
            border: 10px double black;
            width: 100%;
            height: 100%;
            padding: 5px;
            margin: 5px;
        }

        .player_card {
            background-color: #877474;
            float: left;
            width: 10%;
            height: 120%;
            margin: 5px;
            text-align: center;
            border-radius: 2px;
        }

        .row_price {
            width: 96%;
            float: left;
            padding-top: 5px;
            margin-left: 2%;
        }

        .price_card {
            background-color: #c6c6c6;
            float: left;
            width: 100%;
            height: 100%;
            margin: 0px;
            text-align: center;
        }

        .img_card_stonk {
            float: top;
            margin: 0;
            padding: 0;
            margin-bottom: 5px;
            width: 100%;
            height: 30%;
        }

        .text_card_stonk {
            margin: 0;
            margin-top: 5px;
            padding: 25px;
            width: 100%;
            height: 70%;
            float: bottom;

        }

        a {
            text-decoration: none;
            color: #080808;
        }

        .title_stonk {
            float: left;
            width: 22%;
            text-align: center;
            margin-top: auto;
            font-weight: 100;
        }

        .l_prise_stonk {
            float: left;
            width: 22%;
            text-align: center;
            margin-top: auto;
        }

        .prise_stonk {
            float: left;
            width: 22%;
            text-align: center;
            margin-top: auto;
        }

        .img_stonk {
            float: right;
            width: 22%;
            text-align: center;
            margin-top: auto;
        }

        .me_elem {
            width: 10%;
            height: 80%;
            margin: 10px;
            float: right;
        }

        ul {

            /* Убираю маркеры у списка*/
            list-style: none;
            /* Делаю элементы блочными. */
            display: block;
            /* Убираю отступы. */
            margin: 0px;
            /* Убираю еще отступы! */
            padding: 0px;
        }

        ul:after {
            /* Делаю элементы блочными. */
            display: block;
            /* Убираю выравнивание. */
            float: none;
            content: ' ';
            clear: both;
        }

        ul.mmenuu > li {
            /* Задаю выравнивание и позиционирование. */
            float: left;
            /* Считаем координаты относительно исходного места*/
            position: relative;
        }

        ul.mmenuu > li > a {
            /* Делаю элементы блочными: */
            display: block;
            /* Задаю белый цвет. */
            color: #fff;
            /* Задаю отступ 10px. */
            padding: 10px;
            /* Убираю форматирование*/
            text-decoration: none;
            /* Задаю цвет. */
            background-color: #525252;
            border: 2px solid white;
            border-radius: 3px;
        }

        ul.mmenuu > li > a:hover {
            /* Задаю цвет при наведении. */
            background-color: #ffffff;
            color: #000000;
        }

        ul.ssubmenuu {
            position: absolute;
            width: 240px;
            bottom: 37px;
            left: 0px;
            /* Делаю субменю скрытыми. */
            display: none;
            /* Цвет — белый. */
            background-color: white;
        }

        ul.ssubmenuu > li {
            /* Блочное расположение элементов*/
            display: block;
        }

        ul.ssubmenuu > li > a {
            /* Делаю элементы блочными. */
            display: block;
            /* Убираю форматирование*/
            text-decoration: none;
            /* Задаю отступ. */
            padding: 10px;
            /* Задаю цвет. */
            color: #ffffff;
            /* Еще цвет. */
            background-color: #2b2b2b;
        }

        ul.ssubmenuu > li > a:hover {
            background-color: #d7d7d7;
            color: #000000;
            text-decoration: none
        }

        ul.mmenuu > li:hover > ul.ssubmenuu {
            display: block;
            color: #000000;
        }

        br {
            height: 1px
        }

        .play_zone {
            height: 40%;
            width: 100%;


        }

        .log {
            width: 95%;
            height: 20%;
            overflow-y: scroll; /* прокрутка по горизонтали */
            float: bottom;
            background-color: #e9e9e9;
            margin: 10px;
            margin-top: auto;
        }

    </style>
</head>
<body>
<div class="main">
    <div class="modal fade" id="sell_window" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="LongTitle">Игра окончена</h5>
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="sell_stock_input">
                    <label for="message-text" class="col-form-label" id="c_price">Введите количество</label>
                    <input type="text" class="form-control" id="recipient-name">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="fin_cell">Продать</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Игра окончена</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="name_winner">
                    победил игрок
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">заного</button>
                </div>
            </div>
        </div>
    </div>
    <div id="players" style="border-bottom-width: 2px;
                             border-bottom-style: solid;
                             border-bottom-color: #2b2b2b;
                             width: 100%;
                             height: 10%;
                             float: left;
                             background-color: #3c3f41;">
        <div id="online">
            {% for player in current_room.players %}
                {% if player.id != current_user.id %}
                    <div class="player_card">
                        <img src="https://prodota.ru/forum/uploads/profile/photo-182026.png">
                        <h5 id="player_name">{{ player.nickname }}</h5>
                        <h5>{{ player.budget }}</h5>
                        <h5>{{ player.online }}</h5>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <a href="/rooms">
            <div href="/rooms" class="btn btn-outline-light"
                 style="float: right; margin-top: 1.5%; margin-right: 1.7%; width: 10%; height: 50%" id="exit">выйти
            </div>
        </a>

    </div>
    <div id="price">
        <div class="row_price">
            <div class="price_card" style="background-color: transparent;
                                           border-bottom-width: 1px; /* Толщина линии внизу */
                                           border-bottom-style: solid; /* Стиль линии внизу */
                                           border-bottom-color: white;
                                           height: 35px;
                                           min-height: 35px;">
                <font size="5" color="white" face="Arial">
                    <div class="title_stonk"><h5>Компания</h5></div>
                    <div class="prise_stonk"><h5>Цена</h5></div>
                    <div class="l_prise_stonk"><h5>Изменение</h5></div>
                    <div class="inp_stonk"><h5>Колебание</h5></div>
                </font>

            </div>
        </div>
        <br>
        <br>
        <br>
        {% for stock in current_room.stock_list %}
            <div class="row_price" style="width: 100%; margin-left: 0px;">
                <div class="price_card" style="background-color: transparent;
                                                   border-bottom-width: 2px; /* Толщина линии внизу */
                                                   border-bottom-style: solid; /* Стиль линии внизу */
                                                   border-bottom-color: #2b2b2b;
                                                   height: 28px;
                                                   min-height: 28px;">
                    <font size="5" color="white" face="Arial">
                        <div class="title_stonk"><h5 id="com_{{ stock.id }}"> {{ stock.short_name }} </h5></div>
                        <div class="prise_stonk"><h5 id="price_{{ stock.id }}"> {{ stock.cost }} </h5></div>
                        <div class="l_prise_stonk"><h5
                                id="change_{{ stock.id }}"> {{ stock.cost - stock.start_cost }} </h5></div>
                        <div class="img_stonk"><h5 id="image_{{ stock.id }}">
                            {{ '-' if stock.cost - stock.start_cost == 0 else '▼' if stock.cost - stock.start_cost < 0 else '▲' }} </h5>
                        </div>
                    </font>
                </div>
            </div>
        {% endfor %}
        <!-- <div class="log">

        </div> -->

    </div>
    <div id="board" style="width: 60%;
                           height: 80%;
                           display: table-cell;
                           float: left;
                           background-color: #2b2b2b;
                           position: relative">
        <div class="progress" style="float: bottom; height: 2px; background-color: #2b2b2b">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="25"
                 aria-valuemin="0"
                 aria-valuemax="100"></div>
        </div>
        <div class="play_zone">
            <div class="stonks_for_sale" id="stonks_for_sale" style="position: absolute;
                                                                     width: 80%;
                                                                     height: 70%;
                                                                     margin-top: 10%;
                                                                     margin-left: 10%;
                                                                     display: none;">
                {% for i in range(3) %}
                    <div class="card"
                         style="width: 30%; height: 70%; float: left; margin-right: 10px; position: relative"
                         id="stonk_{{ i }}">
                        <div style="width: 60%; height: 40%; margin-left: auto; margin-right: auto">
                            <img src="https://brandslogos.com/wp-content/uploads/images/large/mckinsey-company-logo.png"
                                 alt="..." style="height: auto; width: 90%; margin-left: auto; margin-right: auto">
                        </div>
                        <div style="height: 30%; margin-left: auto; margin-right: auto">
                            <h5> Card title </h5>
                        </div>

                        <div style="height: 30%; margin-left: auto; margin-right: auto">
                            <h5 id="price_s"> price </h5>
                            <h5 id="count_s"> count </h5>
                        </div>

                        <a href="#" class="btn btn-primary" id="{{ 'card_' + i|string }}"
                           style="; margin-left: auto; margin-right: auto; float: bottom"> Buy </a>

                    </div>
                {% endfor %}
            </div>


            <div class="case" id="case" style="position: absolute;
                                               width: 53.333%;
                                               height: 70%;
                                               margin-top: 10%;
                                               margin-left: 23.3335%;
                                               display: none;">
                {% for i in range(2) %}
                    <div class="card" style="width: 45%; height: 70%; float: left; margin-right: 10px"
                         id="case_{{ i }}">
                        <img src="https://www.conchovalleyhomepage.com/wp-content/uploads/sites/83/2020/05/BREAKING-NEWS-GENERIC-1.jpg"
                             class="card-img-top"
                             alt="..." style="width: 100%">
                        <h5 class="card-title">Card title</h5>
                        <div class="card-body">

                        </div>
                    </div>
                {% endfor %}
            </div>

        </div>
        <div style=" margin-right: auto; margin-top: 30%; margin-left: auto; width: 20%; height: 8%; z-index: 999">
            <button class="btn btn-light" id="pas">Пропустить</button>
        </div>
    </div>
    <div id="me">
    <div class="me_elem"> </div>
        <div class="me_elem">
            <ul class="mmenuu">
                <li><a href=#>Недвижимость</a>
                    <ul class="ssubmenuu" id="com">
                        {% for stock in current_room.get_player(current_user.id).stocks %}
                            <li>
                                <h6 style="float: left; margin: 10px">{{ stock.short_name }}</h6>
                                <h6 title="бонус например +1000$ за ход" style="float: left; margin: 10px">
                                    название </h6>
                                <a href="#"> . </a>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            </ul>
        </div>
        <div class="me_elem">
            <ul class="mmenuu">
                <li><a href=#>Портфель</a>
                    <ul class="ssubmenuu" id="bag">
                        {% for stock in current_room.get_player(current_user.id).stocks %}
                            <li>
                                <h6 style="float: left; margin: 10px">{{ stock.short_name }}</h6>
                                <h6 style="float: left; margin: 10px">{{ current_room.get_player(current_user.id).stocks[stock] }}</h6>
                                <a href="#">продать</a>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            </ul>
        </div>

        <font size="5" color="white" face="Arial">
            <div style="height: 80%;
                    width: 10%;
                    margin: 0.7%;
                    padding: 1%;
                    float: left;
                    border-right-width: 1px;
                    border-right-style: solid;
                    border-right-color: white;">
                <div id="money"
                     style="float: right; font-weight: Thin;">{{ current_room.get_player(current_user.id).budget }}</div>
                <div style="margin-left: 5%; float: left;"> $</div>
            </div>
        </font>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
<script type="text/javascript" charset="utf-8"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {
        var progress = 0
        var socket = io();
        socket.on('connect', function () {
            socket.emit('join', {{current_room.id}});
        });
        socket.on('win', function (data) {
            $('#exampleModalCenter').modal('toggle')
            $('#name_winner').text('Победил игрок' + data.nickname)
        });
        $('#exit').click(function () {
            socket.emit('leave', {{current_room.id}});
        });
        $('#pas').click(function () {
            //document.getElementById("pas").disabled = true;
            console.log({{ current_user.redy }})
            socket.emit('decision',
                {
                    'room_id': '{{ current_room.id }}',
                    'player_id': '{{ current_user.id }}',
                    'code': '1'
                })
        });
        $('#card_0').click(function () {
            //document.getElementById("pas").disabled = true;
            socket.emit('decision',
                {
                    'room_id': '{{ current_room.id }}',
                    'player_id': '{{ current_user.id }}',
                    'code': '2',
                    "card_num": '0'
                })
        });
        $('#card_1').click(function () {
            //document.getElementById("pas").disabled = true;
            socket.emit('decision',
                {
                    'room_id': '{{ current_room.id }}',
                    'player_id': '{{ current_user.id }}',
                    'code': '2',
                    "card_num": '1'
                })
        });
        $('#card_2').click(function () {
            //document.getElementById("pas").disabled = true;
            socket.emit('decision',
                {
                    'room_id': '{{ current_room.id }}',
                    'player_id': '{{ current_user.id }}',
                    'code': '2',
                    "card_num": '2'
                })
        });
        socket.on('update_money', function (data) {
            if (data['id'] == {{ current_user.id }}) {
                $('#money').text(data['money'])
            }

        });
        socket.on('log', function (data) {
            $('#log').append('<h6 style="margin: 10px">' + data + '</h6>')
        });
        socket.on('make_turn', function (data) {
            console.log(data)
            var ar = data[1] / data[0]
            progress = 100 * ar
            document.getElementById('progress-bar').style.width = String(progress) + '%';
        });
        $('.sell').click(function () {
            console.log('dddddddddddd')
            $('#exampleModalCenter').modal('toggle')
            $('#name_winner').text('Продажа ' + this.value)
        });
        socket.on('update_bag', function (data) {
            if (data['id'] == {{current_user.id}}) {
                $('#bag').empty()
                for (var stonk in data['data']) {
                    if (data['data'][stonk]['stocks'] != '0') {
                        const elem = $('<li class="sell"><a href = "#" class="sell">'
                            + data['data'][stonk]['short_name'] + ' '
                            + data['data'][stonk]['cost'] + ' | '
                            + data['data'][stonk]['stocks'] + ' продать</a></li>');
                        $('#bag').append(elem);
                        elem.click((e) => {
                            $('#sell_window').modal('toggle')
                            let st = e.target.innerHTML
                            console.log(st)
                            index1 = st.indexOf(' ')
                            index2 = st.indexOf('|')
                            index3 = st.indexOf('продать')
                            f_title = st.slice(0, index1)
                            $('#LongTitle').text("Продать " + f_title)
                            f_count = st.slice(index2 + 1, index3)
                            $('#c_price').text("Введите число, максимум: " + f_count)
                            socket.emit('sell', {
                                'code': '3',
                                'id': {{current_user.id}},
                                'title': f_title,
                                'count': f_count,
                                'room': {{current_room.id}}
                            })

                        });
                    }

                }
            }
        });
        socket.on('update_com', function (data) {
            if (data['id'] == {{current_user.id}}) {
                $('#com').empty()
                console.log(data)
                for (var com in data['data']) {
                    if (data['data'][com] == {{ current_user.id }}) {
                        const elem = $('<li><a href="#">'
                            + com + ' Куплено</a> </li>');
                        $('#com').append(elem);

                    }
                    else {
                        const elem = $('<li><a href = "#"">'
                            + com + '</a></li>');
                        $('#com').append(elem);
                        elem.click((e) => {
                            let st = e.target.innerHTML
                            index1 = st.indexOf('</h6><h6 style="float: left; margin: 10px">')
                            index2 = st.indexOf('; padding: 0p')
                            f_title = st.slice(index2, index1)
                            console.log('dasd' + st)
                            socket.emit('decision', {
                                'code': '4',
                                'player_id': {{current_user.id}},
                                'title': st,
                                'room_id': {{current_room.id}}
                            })

                        });
                    }
                    }

                }
        });
        $('#fin_cell').click(function () {
            count = $('#recipient-name').value
            title = $('#LongTitle').title
            console.log(title)
            //socket.emit('sell', title, count)
        });

        socket.on('update_stock_table', function (json) {
            console.log(json)
            {% for i in range(9) %}
                $('#com_' + {{ i + 1 }}).text(json[{{ i }}]['short_name'])
                $('#price_' + {{ i + 1 }}).text(json[{{ i }}]['cost'])
                $('#change_' + {{ i + 1 }}).text(json[{{ i}}]['change'])
                $('#image_' + {{ i + 1 }}).text(json[{{ i }}]['image'])

            {% endfor %}
        });

        socket.on('update_stock_cards', function (data) {
            //document.getElementById("pas").disabled = false;
            progress = 0
            document.getElementById('case').style.display = 'None';
            var a = document.getElementById('stonks_for_sale').style.display = 'block';
            var fid = 0
            for (var key in data) {
                // console.log(data[key])
                document.querySelector('#stonk_' + String(fid) + '> div > h5').innerHTML = key
                document.querySelector('#stonk_' + String(fid) + '> div > #price_s').innerHTML = data[key]['price'] + '$'
                document.querySelector('#stonk_' + String(fid) + '> div > #count_s').innerHTML = data[key]['quantity'] + 'шт'
                document.querySelector('#stonk_' + String(fid) + '> div > img').src = '' + data[key]['img']
                document.querySelector('#stonk_' + String(fid) + ' > a').innerHTML = 'купить ' + data[key]['cost'] + '$'
                fid++
            }
        });
        socket.on('update_case', function (data) {
            //document.getElementById("pas").disabled = false;
            progress = 0
            document.getElementById('stonks_for_sale').style.display = 'None';
            document.getElementById('case').style.display = 'block';
            var fid = 0
            for (var key in data) {
                //console.log(data)
                $(document.querySelector('#case_' + String(fid) + ' > div')).empty()
                document.querySelector('#case_' + String(fid) + ' > h5').innerHTML = key
                for (var value in data[key]) {
                    $(document.querySelector('#case_' + String(fid) + '> div')).append('<h5>' + value + ' ' + data[key][value] + '$</h5>')

                }

                fid++
            }
        });
        socket.on('clear_playzone', function (data) {
            document.getElementById('case').style.display = 'None';

        });

        socket.on('update_players', function (json) {
            $('#online').empty()
            for (var player in json['data'])
                if (json['data'][player]) {
                    console.log(json['data'])
                    $('#online').append('<a href="#"><div class= "player_card" ><h5 id = "player_n' +
                        'ame" >' + json['data'][player]["nickname"] + '</h5><h5>' + json['data'][player]["budget"] + '</h5></div></a>')
                }
        });


        function refresh_rooms() {

            setTimeout(function () {
                $('#list_rooms').load('list_rooms.php');

                refresh_rooms();

            }, 1000);

        }


        //refresh_rooms();
    });


</script>
</body>
</html>
